{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-semibold text-slate-900">
      Nearby Veterinarians & Help Centers
    </h1>
    <a href="{{ url_for('upload') }}"
       class="text-sm text-emerald-700 hover:text-emerald-800">
      ← Back to dashboard
    </a>
  </div>

  <p class="text-sm text-slate-600 mb-3">
    Area: <span class="font-medium">{{ state }}, {{ district }}</span>
  </p>

  <!-- Simple generic map (no vet markers, no lat/lng needed) -->
  <div id="map" class="w-full"
       style="height: 480px; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb;"></div>

  <h2 class="text-lg font-semibold mt-6 mb-2 text-slate-900">
    Centers in this area
  </h2>
  <div id="vet-list" class="space-y-2 text-sm text-slate-700">
    <div class="text-slate-500">Loading centers…</div>
  </div>
</div>

{# Leaflet CSS & JS #}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  // centers from Flask: list of dicts with at least name/state/district/phone/opening_hours/center_type
  const centers = {{ centers | tojson }};
  const hasCenters = centers.length > 0;

  // ----- MAP: generic India view, no vet coordinates needed -----
  const mapCenter = [21.0, 78.0];  // approx center of India [web:136]
  const map = L.map('map').setView(mapCenter, 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Optional: allow user to click to mark their own location (no DB needed)
  let userMarker = null;
  map.on('click', function (e) {
    if (userMarker) {
      map.removeLayer(userMarker);
    }
    userMarker = L.marker(e.latlng).addTo(map)
      .bindPopup("Your animal's location").openPopup();
  });

  // ----- LIST: show all centers, no lat/lng used -----
  const list = document.getElementById('vet-list');

  if (!hasCenters) {
    list.innerHTML = '<div class="text-slate-500">No centers found for this area.</div>';
  } else {
    let listHtml = '';

    centers.forEach((c, idx) => {
      const phone = c.phone || 'N/A';
      const phoneClean = phone.replace(/[^0-9]/g, '');

      listHtml += `
        <div class="border border-slate-200 rounded-md p-3">
          <div class="font-semibold text-slate-900">${idx + 1}. ${c.name}</div>
          ${c.center_type ? `<div class="text-xs text-emerald-700">${c.center_type}</div>` : ''}
          <div class="text-xs text-slate-600">
            ${(c.district || '') + (c.state ? ', ' + c.state : '')}
          </div>
          ${c.opening_hours ? `
            <div class="text-sm">
              <span class="font-medium">Hours:</span> ${c.opening_hours}
            </div>` : ''}
          <div class="text-sm">
            <span class="font-medium">Phone:</span>
            ${phone !== 'N/A'
              ? `<a href="tel:${phone}" class="text-emerald-700 hover:text-emerald-800">${phone}</a>`
              : 'N/A'}
          </div>
          ${phoneClean ? `
            <div class="mt-1">
              <a href="https://wa.me/${phoneClean}" target="_blank"
                 class="inline-flex items-center px-2 py-1 rounded bg-emerald-50 text-emerald-700 text-xs hover:bg-emerald-100">
                Open in WhatsApp
              </a>
            </div>` : ''}
        </div>
      `;
    });

    list.innerHTML = listHtml;
  }
</script>
{% endblock %}


